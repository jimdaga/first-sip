---
phase: 03-background-job-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker-compose.yml
  - env.local
  - internal/config/config.go
  - go.mod
  - go.sum
autonomous: true

must_haves:
  truths:
    - "Redis container starts and accepts connections on localhost:6379"
    - "Asynqmon web UI is accessible at localhost:8081"
    - "Application config loads REDIS_URL, LOG_LEVEL, LOG_FORMAT from environment"
    - "Redis data persists across container restarts via named volume"
  artifacts:
    - path: "docker-compose.yml"
      provides: "Redis 7 + Asynqmon services alongside existing Postgres"
      contains: "redis_data"
    - path: "env.local"
      provides: "REDIS_URL and logging env vars for local dev"
      contains: "REDIS_URL"
    - path: "internal/config/config.go"
      provides: "RedisURL, LogLevel, LogFormat config fields"
      contains: "RedisURL"
    - path: "go.mod"
      provides: "Asynq dependency"
      contains: "hibiken/asynq"
  key_links:
    - from: "env.local"
      to: "internal/config/config.go"
      via: "REDIS_URL environment variable"
      pattern: "REDIS_URL"
    - from: "docker-compose.yml"
      to: "env.local"
      via: "Redis port 6379 exposed to localhost"
      pattern: "6379:6379"
---

<objective>
Add Redis and Asynqmon to Docker Compose, install the Asynq dependency, and extend application config with Redis URL and structured logging settings.

Purpose: Establish the infrastructure layer (Redis running, Asynq importable, config ready) that Plan 02 builds the worker on top of.
Output: Docker Compose starts Redis+Asynqmon alongside Postgres, config struct has RedisURL/LogLevel/LogFormat fields, Asynq is in go.mod.
</objective>

<execution_context>
@/Users/jim/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jim/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-background-job-infrastructure/03-RESEARCH.md
@.planning/phases/03-background-job-infrastructure/03-CONTEXT.md
@docker-compose.yml
@env.local
@internal/config/config.go
@go.mod
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Redis and Asynqmon to Docker Compose</name>
  <files>docker-compose.yml</files>
  <action>
Add two services to the existing docker-compose.yml (keeping postgres as-is):

1. `redis` service:
   - Image: `redis:7-alpine`
   - Container name: `first-sip-redis`
   - Command: `redis-server --appendonly yes` (AOF persistence per user decision)
   - Ports: `6379:6379`
   - Volume: `redis_data:/data`
   - Healthcheck: `redis-cli ping`, interval 10s, timeout 5s, retries 5
   - Restart: `unless-stopped`

2. `asynqmon` service:
   - Image: `hibiken/asynqmon:latest`
   - Container name: `first-sip-asynqmon`
   - Ports: `8081:8080` (per user decision: localhost:8081)
   - Environment: `REDIS_ADDR=redis:6379`
   - Depends on: `redis`
   - Restart: `unless-stopped`

3. Add `redis_data:` to the volumes section (alongside existing `postgres_data:`).

Do NOT modify the existing postgres service.
  </action>
  <verify>
Run `docker compose config` from the project root to validate YAML syntax. Confirm three services (postgres, redis, asynqmon) and two volumes (postgres_data, redis_data) are present.
  </verify>
  <done>docker-compose.yml has redis + asynqmon services with AOF persistence, healthcheck, and named volume. Validates without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Install Asynq, extend config, update env.local</name>
  <files>go.mod, go.sum, internal/config/config.go, env.local</files>
  <action>
1. Install Asynq dependency:
   ```
   go get github.com/hibiken/asynq@v0.26.0
   ```
   Then run `go mod tidy` to clean up.

2. Update `internal/config/config.go`:
   - Add three fields to the Config struct:
     - `RedisURL   string` — loaded from `REDIS_URL` env var
     - `LogLevel   string` — loaded from `LOG_LEVEL` with default `"debug"` (verbose for dev per user decision)
     - `LogFormat  string` — loaded from `LOG_FORMAT` with default `"text"` (plain text for dev per user decision)
   - In the `Load()` function, add:
     - `RedisURL: os.Getenv("REDIS_URL"),`
     - `LogLevel: getEnvWithDefault("LOG_LEVEL", "debug"),`
     - `LogFormat: getEnvWithDefault("LOG_FORMAT", "text"),`
   - Add a warning block (like the existing DATABASE_URL warning): if `RedisURL` is empty and `Env` is `"production"`, call `log.Fatal("REDIS_URL is required in production")`. If empty in dev, log a warning: `"WARNING: REDIS_URL not set. Background job features will be unavailable."`
   - After loading, if `Env == "production"` and `LogFormat` is still `"text"`, override to `"json"` (JSON logging in production per user decision).

3. Update `env.local`:
   - Add after the existing DATABASE_URL line:
     ```
     # Redis Configuration
     # Redis connection URL for Asynq background job queue
     export REDIS_URL="redis://localhost:6379"
     ```
   - Add after the Application Configuration section:
     ```
     # Logging Configuration
     # Log level: debug, info, warn, error (default: debug for dev)
     export LOG_LEVEL="debug"
     # Log format: text or json (default: text for dev, json forced in production)
     export LOG_FORMAT="text"
     ```

Do NOT change any existing fields or behavior in config.go. Only add new fields.
  </action>
  <verify>
Run `go build ./...` to confirm Asynq is resolvable and config compiles. Run `go vet ./...` to check for issues. Verify `grep -c "RedisURL" internal/config/config.go` returns at least 2 (struct field + assignment).
  </verify>
  <done>Asynq v0.26.0 in go.mod, Config struct has RedisURL/LogLevel/LogFormat fields with env loading and production defaults, env.local has REDIS_URL and logging vars.</done>
</task>

</tasks>

<verification>
1. `docker compose config` validates without errors and shows 3 services, 2 volumes
2. `go build ./...` succeeds with Asynq importable
3. `go vet ./...` reports no issues
4. `grep "REDIS_URL" env.local` shows the new variable
5. `grep "RedisURL" internal/config/config.go` shows struct field and Load() assignment
</verification>

<success_criteria>
- Docker Compose defines redis (7-alpine, AOF, healthcheck, named volume) and asynqmon (port 8081) services
- Asynq v0.26.0 is in go.mod and importable
- Config struct loads RedisURL, LogLevel, LogFormat from environment with appropriate defaults
- env.local has REDIS_URL=redis://localhost:6379, LOG_LEVEL=debug, LOG_FORMAT=text
- All existing functionality (Postgres, auth, models) is unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/03-background-job-infrastructure/03-01-SUMMARY.md`
</output>
