---
phase: 08-plugin-framework-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/plugins/models.go
  - internal/plugins/validator.go
  - internal/database/migrations/000005_create_plugins.up.sql
  - internal/database/migrations/000005_create_plugins.down.sql
autonomous: true

must_haves:
  truths:
    - "Plugin model stores name, description, owner, version, schema_version, capabilities, default_config, and enabled flag in PostgreSQL"
    - "UserPluginConfig links a user to a plugin with user-specific settings (JSONB) and enabled flag"
    - "PluginRun tracks execution with UUID run ID, status lifecycle (pending/processing/completed/failed), input/output JSONB, error message, and timestamps"
    - "User settings can be validated against a JSON Schema file before saving"
    - "Validation errors return descriptive messages indicating which field failed and why"
    - "Database migration creates all three tables with proper indexes and foreign keys"
  artifacts:
    - path: "internal/plugins/models.go"
      provides: "Plugin, UserPluginConfig, PluginRun GORM models with associations and status constants"
      exports: ["Plugin", "UserPluginConfig", "PluginRun", "PluginRunStatusPending", "PluginRunStatusProcessing", "PluginRunStatusCompleted", "PluginRunStatusFailed"]
    - path: "internal/plugins/validator.go"
      provides: "ValidateUserSettings function using kaptinlin/jsonschema"
      exports: ["ValidateUserSettings"]
    - path: "internal/database/migrations/000005_create_plugins.up.sql"
      provides: "SQL migration creating plugins, user_plugin_configs, and plugin_runs tables"
    - path: "internal/database/migrations/000005_create_plugins.down.sql"
      provides: "SQL migration dropping plugin tables"
  key_links:
    - from: "internal/plugins/models.go"
      to: "internal/models/user.go"
      via: "UserPluginConfig.User and PluginRun.User foreign key associations"
      pattern: "models\\.User"
    - from: "internal/plugins/validator.go"
      to: "plugins/*/settings.schema.json"
      via: "ValidateUserSettings reads schema file path and compiles it"
      pattern: "jsonschema\\.NewCompiler"
---

<objective>
Create the GORM database models for plugin persistence and the JSON Schema validator for user settings.

Purpose: The database layer persists plugin metadata after discovery, stores per-user plugin configurations, and tracks every plugin execution run. The validator ensures user settings conform to each plugin's JSON Schema before being saved.

Output: GORM models in internal/plugins/models.go, JSON Schema validator in internal/plugins/validator.go, and SQL migration files.
</objective>

<execution_context>
@/Users/jim/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jim/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-plugin-framework-foundation/08-RESEARCH.md
@internal/models/briefing.go
@internal/models/user.go
@internal/database/migrations/000003_create_briefings.up.sql
@go.mod
</context>

<tasks>

<task type="auto">
  <name>Task 1: GORM models for Plugin, UserPluginConfig, and PluginRun</name>
  <files>internal/plugins/models.go</files>
  <action>
Create `internal/plugins/models.go` in the `plugins` package.

Import the User model from `github.com/jimdaga/first-sip/internal/models` for associations.

Define status constants for PluginRun:
```go
const (
    PluginRunStatusPending    = "pending"
    PluginRunStatusProcessing = "processing"
    PluginRunStatusCompleted  = "completed"
    PluginRunStatusFailed     = "failed"
)
```

**Plugin model** (stores metadata after discovery):
- gorm.Model (ID, CreatedAt, UpdatedAt, DeletedAt)
- Name string `gorm:"uniqueIndex;not null"` -- plugin slug (e.g., "daily-news-digest")
- Description string `gorm:"type:text"`
- Owner string
- Version string `gorm:"not null"` -- semantic version from plugin.yaml
- SchemaVersion string `gorm:"column:schema_version;not null;default:'v1'"` -- metadata schema version
- Capabilities datatypes.JSON `gorm:"type:jsonb"` -- e.g., ["briefing", "scheduled"]
- DefaultConfig datatypes.JSON `gorm:"type:jsonb;column:default_config"` -- default settings
- SettingsSchemaPath string `gorm:"column:settings_schema_path"` -- relative path within plugin dir
- Enabled bool `gorm:"default:true"`

**UserPluginConfig model** (per-user per-plugin settings):
- gorm.Model
- UserID uint `gorm:"not null;uniqueIndex:idx_user_plugin"` -- composite unique with PluginID
- PluginID uint `gorm:"not null;uniqueIndex:idx_user_plugin"`
- Settings datatypes.JSON `gorm:"type:jsonb"` -- user-specific settings validated against schema
- Enabled bool `gorm:"default:false"` -- user must explicitly enable
- User models.User `gorm:"constraint:OnDelete:CASCADE;"`
- Plugin Plugin `gorm:"constraint:OnDelete:CASCADE;"`

**PluginRun model** (execution tracking):
- gorm.Model
- PluginRunID string `gorm:"uniqueIndex;not null"` -- UUID for external tracking (Redis, CrewAI)
- UserID uint `gorm:"not null;index"`
- PluginID uint `gorm:"not null;index"`
- Status string `gorm:"not null;default:'pending';index"` -- pending/processing/completed/failed
- Input datatypes.JSON `gorm:"type:jsonb"` -- snapshot of user settings at execution time
- Output datatypes.JSON `gorm:"type:jsonb"` -- result from CrewAI worker
- ErrorMessage string `gorm:"column:error_message;type:text"`
- StartedAt *time.Time `gorm:"column:started_at"`
- CompletedAt *time.Time `gorm:"column:completed_at"`
- User models.User `gorm:"constraint:OnDelete:CASCADE;"`
- Plugin Plugin `gorm:"constraint:OnDelete:CASCADE;"`

Follow the existing pattern in internal/models/briefing.go for field naming and GORM tags.
  </action>
  <verify>
Run `go build ./internal/plugins/` to confirm the models compile. Check that the import of internal/models works correctly (no circular dependency since plugins imports models, not the other way around).
  </verify>
  <done>
Plugin, UserPluginConfig, and PluginRun models defined with proper GORM tags, associations, status constants, and foreign key constraints matching the existing codebase patterns.
  </done>
</task>

<task type="auto">
  <name>Task 2: JSON Schema validator and SQL migrations</name>
  <files>internal/plugins/validator.go, internal/database/migrations/000005_create_plugins.up.sql, internal/database/migrations/000005_create_plugins.down.sql</files>
  <action>
**validator.go:**

Install kaptinlin/jsonschema: run `go get github.com/kaptinlin/jsonschema` from project root.

Create `ValidateUserSettings(schemaPath string, userSettings map[string]interface{}) error`:
1. Read schema file with os.ReadFile(schemaPath)
2. Create compiler: `jsonschema.NewCompiler()`
3. Compile schema: `compiler.Compile(schemaData)` -- returns (*Schema, error)
4. Marshal userSettings to JSON with json.Marshal
5. Validate: call `schema.Validate(userSettings)` (kaptinlin validates Go values directly, not JSON bytes)
6. Check result with `result.IsValid()`
7. If invalid, iterate result.Errors to collect field-level error messages. Build a single error string with fmt.Errorf listing all failures. Use format: "settings validation failed: field1: message1; field2: message2"
8. Return nil on success

Note: Check the kaptinlin/jsonschema API carefully -- it may use `Validate(interface{})` directly on Go values rather than `ValidateJSON([]byte)`. Consult the library's README for the correct validation method. The key pattern is: Compile schema bytes -> Validate user data -> Check IsValid -> Collect Errors.

**000005_create_plugins.up.sql:**

Follow the exact pattern from 000003_create_briefings.up.sql (BIGSERIAL, TIMESTAMPTZ, same index naming convention).

Create three tables:

1. `plugins` table:
   - id BIGSERIAL PRIMARY KEY
   - created_at, updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
   - deleted_at TIMESTAMPTZ
   - name VARCHAR(255) NOT NULL UNIQUE
   - description TEXT
   - owner VARCHAR(255)
   - version VARCHAR(50) NOT NULL
   - schema_version VARCHAR(10) NOT NULL DEFAULT 'v1'
   - capabilities JSONB
   - default_config JSONB
   - settings_schema_path VARCHAR(255)
   - enabled BOOLEAN NOT NULL DEFAULT true
   - Index: idx_plugins_deleted_at ON plugins(deleted_at)

2. `user_plugin_configs` table:
   - id BIGSERIAL PRIMARY KEY
   - created_at, updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
   - deleted_at TIMESTAMPTZ
   - user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE
   - plugin_id BIGINT NOT NULL REFERENCES plugins(id) ON DELETE CASCADE
   - settings JSONB
   - enabled BOOLEAN NOT NULL DEFAULT false
   - UNIQUE(user_id, plugin_id)
   - Indexes: idx_user_plugin_configs_deleted_at, idx_user_plugin_configs_user_id, idx_user_plugin_configs_plugin_id

3. `plugin_runs` table:
   - id BIGSERIAL PRIMARY KEY
   - created_at, updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
   - deleted_at TIMESTAMPTZ
   - plugin_run_id VARCHAR(36) NOT NULL UNIQUE
   - user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE
   - plugin_id BIGINT NOT NULL REFERENCES plugins(id) ON DELETE CASCADE
   - status VARCHAR(50) NOT NULL DEFAULT 'pending'
   - input JSONB
   - output JSONB
   - error_message TEXT
   - started_at TIMESTAMPTZ
   - completed_at TIMESTAMPTZ
   - Indexes: idx_plugin_runs_deleted_at, idx_plugin_runs_user_id, idx_plugin_runs_plugin_id, idx_plugin_runs_status

**000005_create_plugins.down.sql:**

Drop tables in reverse order (to respect foreign keys):
```sql
DROP TABLE IF EXISTS plugin_runs;
DROP TABLE IF EXISTS user_plugin_configs;
DROP TABLE IF EXISTS plugins;
```
  </action>
  <verify>
Run `go get github.com/kaptinlin/jsonschema` and then `go build ./internal/plugins/` to confirm compilation. Verify migration files exist and have valid SQL syntax by checking they parse correctly (the app will run them on next startup via golang-migrate).
  </verify>
  <done>
ValidateUserSettings compiles JSON Schema and validates user settings with descriptive error messages. Migration 000005 creates plugins, user_plugin_configs, and plugin_runs tables with proper indexes, foreign keys, and cascading deletes.
  </done>
</task>

</tasks>

<verification>
```bash
# Dependencies installed
go mod tidy

# All files compile
go build ./internal/plugins/

# No vet issues
go vet ./internal/plugins/

# Migration files exist
ls internal/database/migrations/000005_*

# Verify model exports
go doc ./internal/plugins/ Plugin
go doc ./internal/plugins/ ValidateUserSettings
```
</verification>

<success_criteria>
- Plugin, UserPluginConfig, PluginRun models defined with GORM tags matching existing codebase patterns
- Status constants defined for PluginRun lifecycle
- ValidateUserSettings compiles JSON Schema from file and validates user settings
- Migration 000005 creates all three tables with proper constraints
- Down migration drops tables in correct order
- All code compiles and passes go vet
</success_criteria>

<output>
After completion, create `.planning/phases/08-plugin-framework-foundation/08-02-SUMMARY.md`
</output>
