---
phase: 08-plugin-framework-foundation
plan: 03
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - plugins/daily-news-digest/plugin.yaml
  - plugins/daily-news-digest/settings.schema.json
  - internal/plugins/loader.go
  - internal/database/seed.go
  - cmd/server/main.go
autonomous: true

must_haves:
  truths:
    - "A daily-news-digest plugin directory exists with valid plugin.yaml and settings.schema.json"
    - "Plugin registry loads daily-news-digest at application startup"
    - "Plugin metadata is persisted to the database after discovery (upsert pattern)"
    - "Dev seed data creates a UserPluginConfig for the dev user with daily-news-digest enabled"
    - "Application starts successfully with plugin loading and logs discovered plugins"
  artifacts:
    - path: "plugins/daily-news-digest/plugin.yaml"
      provides: "Complete plugin metadata YAML for the example news digest plugin"
      contains: "name: daily-news-digest"
    - path: "plugins/daily-news-digest/settings.schema.json"
      provides: "JSON Schema (Draft 2020-12) defining user-configurable settings for news digest"
      contains: "$schema"
    - path: "internal/plugins/loader.go"
      provides: "InitPlugins function that discovers plugins, syncs to DB, and returns populated registry"
      exports: ["InitPlugins"]
    - path: "internal/database/seed.go"
      provides: "Updated seed function that also creates UserPluginConfig for dev user"
    - path: "cmd/server/main.go"
      provides: "Plugin registry initialization on startup via InitPlugins call"
  key_links:
    - from: "cmd/server/main.go"
      to: "internal/plugins/loader.go"
      via: "main() calls InitPlugins after database migrations"
      pattern: "plugins\\.InitPlugins"
    - from: "internal/plugins/loader.go"
      to: "internal/plugins/registry.go"
      via: "InitPlugins uses LoadRegistry to discover and register plugins"
      pattern: "LoadRegistry"
    - from: "internal/plugins/loader.go"
      to: "internal/plugins/models.go"
      via: "InitPlugins syncs discovered plugins to Plugin database table"
      pattern: "db\\..*Plugin"
    - from: "plugins/daily-news-digest/plugin.yaml"
      to: "plugins/daily-news-digest/settings.schema.json"
      via: "settings_schema_path field references the schema file"
      pattern: "settings_schema_path"
---

<objective>
Create the daily-news-digest example plugin and wire plugin discovery into the application startup flow.

Purpose: Validates the entire plugin framework end-to-end: YAML metadata is parsed, plugin is discovered, metadata is persisted to the database, and the registry is available for the rest of the application. The example plugin also provides the settings schema that will be used for validation testing.

Output: Working example plugin directory, startup integration in main.go, and seed data for development.
</objective>

<execution_context>
@/Users/jim/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jim/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-plugin-framework-foundation/08-RESEARCH.md
@.planning/phases/08-plugin-framework-foundation/08-01-SUMMARY.md
@.planning/phases/08-plugin-framework-foundation/08-02-SUMMARY.md
@internal/database/seed.go
@cmd/server/main.go
@internal/config/config.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Example plugin files (plugin.yaml and settings.schema.json)</name>
  <files>plugins/daily-news-digest/plugin.yaml, plugins/daily-news-digest/settings.schema.json</files>
  <action>
Create `plugins/daily-news-digest/` directory.

**plugin.yaml:**
```yaml
name: daily-news-digest
description: Generates a personalized daily news digest based on your selected topics and interests
owner: first-sip
version: 1.0.0
schema_version: v1

capabilities:
  - briefing
  - scheduled

default_config:
  frequency: daily
  preferred_time: "06:00"
  topics:
    - technology
    - business

settings_schema_path: settings.schema.json
```

**settings.schema.json:**
```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Daily News Digest Settings",
  "description": "Configure your daily news digest preferences",
  "type": "object",
  "properties": {
    "frequency": {
      "type": "string",
      "enum": ["daily", "weekly"],
      "default": "daily",
      "description": "How often to generate the digest"
    },
    "preferred_time": {
      "type": "string",
      "pattern": "^([0-1][0-9]|2[0-3]):[0-5][0-9]$",
      "default": "06:00",
      "description": "Preferred delivery time in HH:MM format (24-hour)"
    },
    "topics": {
      "type": "array",
      "items": {
        "type": "string",
        "enum": ["technology", "business", "science", "health", "politics", "sports", "entertainment"]
      },
      "minItems": 1,
      "maxItems": 5,
      "default": ["technology"],
      "description": "News topics to include in the digest"
    },
    "summary_length": {
      "type": "string",
      "enum": ["brief", "standard", "detailed"],
      "default": "standard",
      "description": "Length of article summaries"
    }
  },
  "required": ["frequency", "preferred_time", "topics"]
}
```

Also create an empty `plugins/daily-news-digest/crew/` directory with a `.gitkeep` file to reserve space for the CrewAI workflow that will be added in Phase 9.
  </action>
  <verify>
Verify the YAML is valid by parsing it: `go run -e 'package main; ...'` is overkill -- just ensure the file exists and is well-formed. Check with: `python3 -c "import yaml; yaml.safe_load(open('plugins/daily-news-digest/plugin.yaml'))"` and `python3 -c "import json; json.load(open('plugins/daily-news-digest/settings.schema.json'))"`.
  </verify>
  <done>
plugins/daily-news-digest/ directory exists with valid plugin.yaml (all required fields, schema_version v1) and settings.schema.json (Draft 2020-12, validates frequency, preferred_time pattern, topics array with constraints).
  </done>
</task>

<task type="auto">
  <name>Task 2: Startup loader, seed data update, and main.go wiring</name>
  <files>internal/plugins/loader.go, internal/database/seed.go, cmd/server/main.go</files>
  <action>
**loader.go** (new file in internal/plugins/):

Create `InitPlugins(db *gorm.DB, pluginDir string) (*Registry, error)`:
1. Call LoadRegistry(pluginDir) to discover and register plugins from disk
2. Log: "Discovered %d plugin(s) from %s" with registry.Count() and pluginDir
3. Sync each discovered plugin to database using upsert pattern:
   - For each plugin in registry.List():
     - Marshal Capabilities to datatypes.JSON (json.Marshal the []string)
     - Marshal DefaultConfig to datatypes.JSON (json.Marshal the map)
     - Use db.Where("name = ?", meta.Name).FirstOrCreate(&dbPlugin) to find or create
     - If plugin already existed (dbPlugin.ID != 0 before FirstOrCreate), update its fields with db.Model(&dbPlugin).Updates() to sync version, description, schema_version, etc. from the YAML (so restarting with updated plugin.yaml propagates changes)
   - Log each synced plugin: "Synced plugin to database: %s (version %s)"
4. Return the registry

Import gorm.io/gorm, gorm.io/datatypes, encoding/json, log.

**seed.go** (update existing file):

Add to the existing SeedDevData function, AFTER the existing briefing seed data:
1. Find the daily-news-digest Plugin record: `db.Where("name = ?", "daily-news-digest").First(&plugin)`
2. If found (no error), create a UserPluginConfig for the dev user:
   - UserID: user.ID (from the existing dev user created above)
   - PluginID: plugin.ID
   - Enabled: true
   - Settings: datatypes.JSON with the default config: `{"frequency":"daily","preferred_time":"07:00","topics":["technology","business"]}`
3. Use FirstOrCreate with Where("user_id = ? AND plugin_id = ?") to be idempotent
4. If plugin not found, log a warning but do NOT fail (plugins may not be loaded yet on first seed)
5. Update the final log line to include the plugin config: "Seeded dev data: 1 user, 1 auth identity, 2 briefings, 1 plugin config"

Import the plugins package for the Plugin model: `github.com/jimdaga/first-sip/internal/plugins`

**main.go** (update existing file):

Add plugin initialization AFTER database migrations and seed data, BEFORE mode branching (before the `if *workerMode` block):

```go
// Initialize plugin registry
var pluginRegistry *plugins.Registry
if db != nil {
    var err error
    pluginRegistry, err = plugins.InitPlugins(db, "./plugins")
    if err != nil {
        log.Printf("Warning: plugin initialization failed: %v", err)
    } else {
        log.Printf("Plugin registry loaded: %d plugin(s)", pluginRegistry.Count())
    }
}
```

Add import: `"github.com/jimdaga/first-sip/internal/plugins"`

The pluginRegistry variable will be used by later phases (dashboard tiles, settings page, etc.) but for now it just needs to exist and be populated at startup. Do NOT fail fatally if plugin loading fails -- log a warning so the app can still serve its existing v1.0 functionality.

Add `PluginDir` field to config.Config struct with default value `"./plugins"`:
- Add `PluginDir string` field to Config struct
- In Load(), set it: `PluginDir: getEnvWithDefault("PLUGIN_DIR", "./plugins")`
- Use cfg.PluginDir instead of hardcoded "./plugins" in main.go
  </action>
  <verify>
Run `make build` to verify the entire application compiles with the plugin system wired in. Then run `make dev` briefly (Ctrl+C after startup) to confirm the app starts, discovers the daily-news-digest plugin, and logs "Plugin registry loaded: 1 plugin(s)". Check for any database migration errors in the startup log.
  </verify>
  <done>
Application starts with plugin discovery, loads daily-news-digest from plugins/ directory, syncs metadata to plugins database table, dev seed creates UserPluginConfig for the dev user, and startup logs confirm "Plugin registry loaded: 1 plugin(s)".
  </done>
</task>

</tasks>

<verification>
```bash
# Full build succeeds
make build

# Plugin YAML is valid
python3 -c "import yaml; d=yaml.safe_load(open('plugins/daily-news-digest/plugin.yaml')); assert d['name'] == 'daily-news-digest'"

# Settings schema is valid JSON
python3 -c "import json; d=json.load(open('plugins/daily-news-digest/settings.schema.json')); assert d['type'] == 'object'"

# App starts and discovers plugins (manual verification during dev)
# Expected log output includes:
#   "Discovered 1 plugin(s) from ./plugins"
#   "Synced plugin to database: daily-news-digest (version 1.0.0)"
#   "Plugin registry loaded: 1 plugin(s)"
```
</verification>

<success_criteria>
- plugins/daily-news-digest/ exists with valid plugin.yaml and settings.schema.json
- InitPlugins discovers, syncs to DB, and returns populated Registry
- Seed data creates UserPluginConfig linking dev user to daily-news-digest
- main.go initializes plugin registry at startup with graceful error handling
- PluginDir config field added with PLUGIN_DIR env var support
- Application compiles and starts successfully with plugin system active
</success_criteria>

<output>
After completion, create `.planning/phases/08-plugin-framework-foundation/08-03-SUMMARY.md`
</output>
