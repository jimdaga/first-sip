---
phase: 07-briefing-history
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/briefings/handlers.go
  - internal/briefings/templates.templ
  - internal/templates/dashboard.templ
  - cmd/server/main.go
  - static/css/liquid-glass.css
autonomous: true

must_haves:
  truths:
    - "Dashboard navbar shows a History link"
    - "History page displays last 30 days of completed briefings in reverse chronological order"
    - "Briefings are grouped by date with visual date separators"
    - "User can click a briefing card to mark it read (consistent with dashboard behavior)"
    - "Read/unread badges appear on history briefing cards"
    - "Load More button appears when more than 10 briefings exist"
    - "Empty state displays when user has no briefings in last 30 days"
    - "Briefings older than 30 days are retained in database but hidden from history view"
  artifacts:
    - path: "internal/briefings/handlers.go"
      provides: "GetHistoryHandler (full page), GetHistoryPageHandler (HTMX fragment for Load More)"
      exports: ["GetHistoryHandler", "GetHistoryPageHandler"]
    - path: "internal/briefings/templates.templ"
      provides: "HistoryPage, HistoryList, HistoryBriefingCard components"
      contains: "templ HistoryPage"
    - path: "internal/templates/dashboard.templ"
      provides: "History link in navbar"
      contains: "/history"
    - path: "cmd/server/main.go"
      provides: "Route registration for /history and /api/history"
      contains: "/history"
    - path: "static/css/liquid-glass.css"
      provides: "History page styles: date-separator, navbar-link, history layout"
      contains: ".history-"
  key_links:
    - from: "internal/templates/dashboard.templ"
      to: "/history"
      via: "navbar anchor tag"
      pattern: "href=\"/history\""
    - from: "cmd/server/main.go"
      to: "internal/briefings/handlers.go"
      via: "route registration"
      pattern: "briefings\\.GetHistory"
    - from: "internal/briefings/handlers.go"
      to: "gorm.DB"
      via: "GORM query with user_id filter and 30-day scope"
      pattern: "created_at >= .*AddDate"
    - from: "internal/briefings/templates.templ"
      to: "/api/history"
      via: "HTMX Load More button"
      pattern: "hx-get.*api/history"
    - from: "internal/briefings/templates.templ"
      to: "/api/briefings/:id/read"
      via: "click-to-mark-read on history cards"
      pattern: "hx-post.*briefings.*read"
---

<objective>
Add a browsable briefing history page with 30-day retention, date grouping, pagination, and read tracking.

Purpose: Completes the v1 experience by letting users review past briefings — the final phase of the roadmap.
Output: Working /history page with paginated briefing list, date separators, read/unread badges, and "Load More" HTMX pagination.
</objective>

<execution_context>
@/Users/jim/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jim/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-briefing-history/07-RESEARCH.md
@internal/briefings/handlers.go
@internal/briefings/templates.templ
@internal/templates/dashboard.templ
@internal/templates/layout.templ
@cmd/server/main.go
@internal/models/briefing.go
@internal/models/user.go
@static/css/liquid-glass.css
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: History handlers and route wiring</name>
  <files>internal/briefings/handlers.go, cmd/server/main.go</files>
  <action>
Add two new handlers to `internal/briefings/handlers.go`:

**GetHistoryHandler(db *gorm.DB) gin.HandlerFunc** — Full page handler for GET /history:
- Get user email from context via `c.Get("user_email")` (same pattern as CreateBriefingHandler)
- Look up user by email to get GORM uint ID
- Query briefings: `db.Where("user_id = ? AND created_at >= ?", user.ID, time.Now().AddDate(0, 0, -30)).Where("status IN ?", []string{models.BriefingStatusCompleted, models.BriefingStatusFailed}).Order("created_at DESC").Limit(11).Find(&briefings)`
- Use Limit(11) to fetch pageSize+1 to detect hasMore; if len > 10, trim to 10 and set hasMore=true
- Get user name from context for the page header
- Render the full HistoryPage component: `HistoryPage(nameStr, briefings, 0, hasMore)`

**GetHistoryPageHandler(db *gorm.DB) gin.HandlerFunc** — HTMX fragment handler for GET /api/history?page=N:
- Same user lookup pattern
- Parse `page` query param with `strconv.Atoi(c.DefaultQuery("page", "0"))`
- Same query but with `.Offset(page * 10)` added
- Render only the HistoryList fragment: `HistoryList(briefings, page, hasMore)`
- This is what the "Load More" button calls

Import additions needed: `"strconv"`, `"time"`.

**Route wiring in cmd/server/main.go:**
- Inside the `protected` group (after the existing briefing routes), add:
  - `protected.GET("/history", briefings.GetHistoryHandler(db))` — note: this is a direct handler call, NOT wrapped in an anonymous func like /dashboard
  - `protected.GET("/api/history", briefings.GetHistoryPageHandler(db))`
- The /history route needs the same user context that RequireAuth middleware provides

**Important:** Filter to only show completed and failed briefings in history (not pending/processing — those are transient states). Include failed briefings for transparency per research recommendation.

**Important:** Always filter by user_id to prevent data leaks between users (see research Pitfall 5).
  </action>
  <verify>
Run `make templ-generate && go build ./cmd/server/` to confirm compilation. If templ templates from Task 2 are not yet created, verify handler code compiles by temporarily commenting out template render calls and confirming the Go code has no syntax errors.
  </verify>
  <done>
Two new exported handler functions exist in handlers.go. Routes /history and /api/history are registered in main.go under the protected group. History queries filter by user_id, last 30 days, and completed/failed status. Pagination uses Limit(11)/Offset with hasMore detection.
  </done>
</task>

<task type="auto">
  <name>Task 2: History templates, navbar link, and CSS styles</name>
  <files>internal/briefings/templates.templ, internal/templates/dashboard.templ, static/css/liquid-glass.css</files>
  <action>
**Add Templ components to `internal/briefings/templates.templ`:**

1. **HistoryPage(name string, briefings []models.Briefing, page int, hasMore bool)** — Full page wrapped in Layout:
```
@templates.Layout("History - First Sip") {
    <nav class="glass-navbar">
        <div class="navbar-inner">
            <div class="navbar-brand">
                <a href="/dashboard" class="navbar-brand-link">
                    <img src="/static/img/logo.png" alt="" class="navbar-logo"/>
                    <span class="navbar-title">First Sip</span>
                </a>
            </div>
            <div class="navbar-actions">
                <a href="/history" class="navbar-link navbar-link-active">History</a>
                <span class="navbar-user">{ name }</span>
                <a href="/logout" class="glass-btn glass-btn-ghost glass-btn-sm">Logout</a>
            </div>
        </div>
    </nav>
    <main class="dashboard-content">
        <div class="history-header">
            <h1 class="greeting">Briefing History</h1>
            <p class="history-subtitle">Last 30 days</p>
        </div>
        @HistoryList(briefings, page, hasMore)
    </main>
}
```
Import `"github.com/jimdaga/first-sip/internal/templates"` at top of file.

2. **HistoryList(briefings []models.Briefing, page int, hasMore bool)** — Renders list with date grouping. This is the HTMX-swappable fragment:
- If `len(briefings) == 0 && page == 0`: render empty state div with class "empty-state" containing "No briefings in the last 30 days." and a link back to dashboard
- Otherwise: iterate briefings, track `lastDate` string variable using Templ code blocks `{{ }}`
- For each briefing, format `briefing.CreatedAt.Format("January 2, 2006")` as currentDate
- When currentDate != lastDate, render a date separator: `<div class="history-date-group"><span class="history-date-label">{ currentDate }</span></div>` and update lastDate
- Render each briefing using `@HistoryBriefingCard(briefing)` (NOT the existing BriefingCard — history needs a simpler variant)
- After the loop, if hasMore: render Load More button inside `<div id="load-more-row">` with `hx-get={ fmt.Sprintf("/api/history?page=%d", page+1) }`, `hx-target="#load-more-row"`, `hx-swap="outerHTML"`, class "glass-btn glass-btn-ghost history-load-more"

3. **HistoryBriefingCard(briefing models.Briefing)** — Compact card for history list:
- Wrap in `<div class="glass-card history-card">` with `hx-post={ fmt.Sprintf("/api/briefings/%d/read", briefing.ID) }`, `hx-target="closest .history-card"`, `hx-swap="outerHTML"`, `style="cursor: pointer"`
- Only add hx-post if `briefing.Status == models.BriefingStatusCompleted` (no mark-read for failed)
- Card body contains:
  - Row with "Daily Briefing" title (class "briefing-card-title") + read/unread badge (same glass-badge pattern as existing BriefingCard)
  - Time display: `briefing.CreatedAt.Format("3:04 PM")` in a span with class "history-card-time"
  - If status is failed: show small error indicator text "Generation failed" in status-unread-text color
  - If completed and has content: show a brief preview — just the first section title or a "3 sections" summary line in text-secondary color. Keep it simple: render `fmt.Sprintf("%d sections", countSections(briefing))` or just "View briefing" as a teaser. Do NOT render full BriefingContentView in history cards.
- After marking read via hx-post, the existing MarkBriefingReadHandler returns a BriefingCard. That handler needs to be aware it might be called from history context. For simplicity: create a separate **MarkHistoryBriefingReadHandler** in handlers.go that returns HistoryBriefingCard instead. Add route: `protected.POST("/api/history/briefings/:id/read", briefings.MarkHistoryBriefingReadHandler(db))`. The handler logic is identical to MarkBriefingReadHandler but renders HistoryBriefingCard. Update the hx-post URL in HistoryBriefingCard to use `/api/history/briefings/:id/read`.

**Update `internal/templates/dashboard.templ`:**
- In the navbar-actions div, add a History link BEFORE the navbar-user span:
  `<a href="/history" class="navbar-link">History</a>`
- Make the navbar-brand a link to /dashboard: wrap the existing img+span in `<a href="/dashboard" class="navbar-brand-link">...</a>`

**Add CSS to `static/css/liquid-glass.css`:**

Add before the `/* -- Responsive --*/` section:

```css
/* -- History Page -- */
.history-header {
  margin-bottom: 1.5rem;
  animation: fadeInUp 0.7s var(--ease-spring) 0.1s both;
}

.history-subtitle {
  font-size: 0.9rem;
  color: var(--text-secondary);
  margin-top: 0.25rem;
}

.history-date-group {
  padding: 0.75rem 0 0.5rem;
}

.history-date-group:first-child {
  padding-top: 0;
}

.history-date-label {
  font-family: var(--font-display);
  font-weight: 600;
  font-size: 0.85rem;
  color: var(--text-secondary);
  letter-spacing: 0.02em;
}

.history-card {
  margin-bottom: 0.75rem;
}

.history-card .glass-card-body {
  padding: 1rem 1.25rem;
}

.history-card-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.75rem;
}

.history-card-meta {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-top: 0.35rem;
}

.history-card-time {
  font-size: 0.8rem;
  color: var(--text-tertiary);
}

.history-card-preview {
  font-size: 0.8rem;
  color: var(--text-secondary);
}

.history-card-failed {
  font-size: 0.8rem;
  color: var(--status-unread-text);
}

.history-load-more {
  width: 100%;
  margin-top: 0.5rem;
  justify-content: center;
}

/* Navbar link */
.navbar-link {
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--text-secondary);
  text-decoration: none;
  transition: color 0.2s ease;
}

.navbar-link:hover {
  color: var(--text-primary);
}

.navbar-link-active {
  color: var(--accent);
}

.navbar-brand-link {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  text-decoration: none;
}
```

Also add responsive adjustments inside the existing `@media (min-width: 768px)` block:
```css
.history-date-label {
  font-size: 0.9rem;
}
```

After all template changes, run `make templ-generate` to compile .templ to _templ.go files.
  </action>
  <verify>
Run `make templ-generate && go build ./cmd/server/` — must compile without errors. Verify the generated `internal/briefings/templates_templ.go` contains HistoryPage, HistoryList, and HistoryBriefingCard functions.
  </verify>
  <done>
History page template renders with navbar (including active History link), date-grouped briefing list, empty state, and Load More pagination. Dashboard navbar has History link. CSS styles follow Liquid Glass design system with proper tokens. All templates compile via templ-generate. Application builds successfully.
  </done>
</task>

</tasks>

<verification>
1. `make templ-generate && go build ./cmd/server/` compiles without errors
2. `make test` passes (existing tests still work)
3. Start app with `make dev`, log in, navigate to /history — page renders
4. History page shows navbar with "History" link highlighted
5. Dashboard page shows "History" link in navbar
6. If briefings exist in last 30 days, they appear grouped by date
7. If no briefings exist, empty state message appears
8. Clicking a completed briefing card marks it as read (badge changes)
9. Read/unread badges display correctly on history cards
10. "Load More" button appears if more than 10 briefings exist (test by temporarily setting pageSize to 2)
</verification>

<success_criteria>
- /history page is accessible from dashboard navbar
- History displays last 30 days of completed and failed briefings
- Briefings are in reverse chronological order, grouped by date
- Read/unread state is visible and clickable
- Pagination works via HTMX Load More
- Empty state renders when no history exists
- Briefings older than 30 days are retained in DB but not shown
- All existing functionality (dashboard, generation, mark-read) continues to work
</success_criteria>

<output>
After completion, create `.planning/phases/07-briefing-history/07-01-SUMMARY.md`
</output>
